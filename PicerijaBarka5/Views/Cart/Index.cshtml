@model PicerijaBarka5.Models.CartOrder
@using Newtonsoft.Json
@{
    ViewBag.Title = "Cart";
}

<h2>Cart</h2>

@{
    if (ViewBag.Valid == "True")
    {
        <table class="table">
            <tr>
                <th>
                    Name of the pizza
                </th>
                <th>
                    Price
                </th>
                <th>
                    Quantity in cart
                </th>
                <th></th>
            </tr>

            @foreach (var item in Model.Items)
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.Key.Name)
                    </td>
                    <td>
                        @item.Key.getPrice()
                    </td>
                    <td>
                        @item.Value
                    </td>
                    <td>
                        <button class="btn btn-danger removeFromCart" item-id="@item.Key.PizzaId">Remove from cart</button>
                        @{ 
                            //TODO: Implement AJAX CALL
                        }
                    </td>
                </tr>
            }

        </table>

        @Model.Items.Sum(x => x.Key.getPrice() * x.Value)

        <div class="form-group">
            <label for="address">Address</label>
            <input type="text" name="Address" class="form-control" id="address"/>
            
        </div>
       
        <button class="btn btn-primary" id="makeOrderButton">Make order</button>


    }
    else
    {
        <h1>Your cart is empty!</h1>
        <h3>Are you full or just haven't chosen a pizza yet?</h3>
    }

}


@section scripts{
    @{
        var data = (PicerijaBarka5.Models.CartOrder)Session["cart"];
        var orderFromCart = JsonConvert.SerializeObject(data, new JsonSerializerSettings { Formatting = Formatting.None, ReferenceLoopHandling = ReferenceLoopHandling.Ignore });
    }
    <script>

        $("#makeOrderButton").on('click', function () {
            let address = $("#address").val();

            $.ajax({
                type: "POST",
                url: "/Orders/Create?Address=" + address,
                data: @Html.Raw(orderFromCart),
                success: function () {
                    alert("Your order has been placed");
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("Enter a valid address")
                },
                dataType: "json"
            })
        })

        $(".removeFromCart").on('click', function () {
            let id = $(this).attr("item-id");

            $.ajax({
                type: "DELETE",
                url: "/Cart/RemoveFromCart/" + id,
                success: function () {
                    alert("Item successfully removed from cart");
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("Enter a valid address")
                },
                dataType: "json"
            })
        })
    </script>
}
